#!/bin/zsh
source ~/.zshrc 2>/dev/null

selected=$(
    { find "$HOME/Projects" -mindepth 1 -maxdepth 1 -type d
      find "$HOME/Projects/cpi" -mindepth 1 -maxdepth 1 -type d 2>/dev/null
      echo "$HOME/dotfiles"
    } | fzf --prompt="  "
)
[ -z "$selected" ] && exit 0

name=$(basename "$selected" | tr '. ' '__')

if ! tmux has-session -t "$name" 2>/dev/null; then
    tmux new-session -d -s "$name" -c "$selected"
    [[ -f "$selected/.venv/bin/activate" ]] && tmux send-keys -t "$name":1 "source .venv/bin/activate" Enter
    tmux new-window -t "$name" && [[ -f "$selected/.venv/bin/activate" ]] && tmux send-keys -t "$name":2 "source .venv/bin/activate" Enter
    tmux new-window -t "$name" && [[ -f "$selected/.venv/bin/activate" ]] && tmux send-keys -t "$name":3 "source .venv/bin/activate" Enter
    tmux link-window -s default:9 -t "$name":9 2>/dev/null || true
    tmux select-window -t "$name":1
fi

tmux switch-client -t "$name"
